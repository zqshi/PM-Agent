<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>环节详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="js/process-flow-service.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#4f46e5',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f8fafc;
        }
        .sidebar {
            width: 250px;
        }
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            min-width: 120px;
            font-weight: 600;
            color: #64748b;
        }
        .info-value {
            flex: 1;
            color: #1e293b;
        }
        .doc-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.2s;
        }
        .doc-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37,99,235,0.1);
        }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="sidebar bg-white shadow-md h-screen fixed left-0 top-0 z-10">
        <div class="p-4 flex items-center justify-between border-b">
            <div class="flex items-center">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/e10cd3e372b34c81bd38e133e4bd5b6f~tplv-a9rns2rl98-image.image?rcl=202510281322428F39A82D876F62A3D046&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1764221004&x-signature=F1qcXPuf02II05L0PsQjVA3rO4o%3D" alt="Logo" class="h-8">
                <h1 class="ml-2 text-lg font-bold text-gray-800">ProductCoCreate</h1>
            </div>
        </div>
        <nav class="mt-4">
            <ul>
                <li>
                    <a href="dashboard.html" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 transition-all">
                        <i class="fa fa-dashboard w-6 text-center"></i>
                        <span class="ml-3">仪表盘</span>
                    </a>
                </li>
                <li>
                    <a href="project-management.html" class="bg-blue-50 text-primary border-l-4 border-primary flex items-center px-4 py-3 hover:bg-blue-50 transition-all">
                        <i class="fa fa-folder-open w-6 text-center"></i>
                        <span class="ml-3">项目管理</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 transition-all" onclick="event.preventDefault(); alert('系统设置功能正在开发中，敬请期待！');">
                        <i class="fa fa-cog w-6 text-center"></i>
                        <span class="ml-3">系统设置</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 flex-1 min-h-screen p-6">
        <!-- Breadcrumb -->
        <nav class="flex mb-6 text-sm">
            <a href="project-management.html" class="text-primary hover:text-secondary">项目管理</a>
            <span class="mx-2 text-gray-400">/</span>
            <a href="#" class="text-primary hover:text-secondary" id="projectLink">项目</a>
            <span class="mx-2 text-gray-400">/</span>
            <a href="#" class="text-primary hover:text-secondary" id="versionLink">版本</a>
            <span class="mx-2 text-gray-400">/</span>
            <a href="#" class="text-primary hover:text-secondary" id="processLink">流程</a>
            <span class="mx-2 text-gray-400">/</span>
            <span class="text-gray-600" id="stepName">环节详情</span>
        </nav>

        <!-- Step Header -->
        <div class="info-card">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center" id="stepIconContainer" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fa fa-circle text-white text-3xl" id="stepIcon"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2" id="stepTitle">加载中...</h1>
                        <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 rounded-full text-sm font-medium" id="stepStatus">--</span>
                            <span class="text-sm text-gray-600" id="stepAgent">Agent: --</span>
                        </div>
                    </div>
                </div>
                <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-all" onclick="goBack()">
                    <i class="fa fa-arrow-left mr-2"></i>返回流程
                </button>
            </div>
        </div>

        <!-- Time Info -->
        <div class="info-card">
            <h3 class="text-lg font-bold text-gray-800 mb-4">⏱️ 时间信息</h3>
            <div class="info-row">
                <div class="info-label">开始时间</div>
                <div class="info-value" id="startTime">--</div>
            </div>
            <div class="info-row">
                <div class="info-label">完成时间</div>
                <div class="info-value" id="endTime">--</div>
            </div>
            <div class="info-row">
                <div class="info-label">耗时</div>
                <div class="info-value" id="duration">--</div>
            </div>
        </div>

        <!-- Input Output -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Input -->
            <div class="info-card">
                <h3 class="text-lg font-bold text-gray-800 mb-4">📥 输入</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700" id="stepInput">
                    --
                </div>
            </div>

            <!-- Output -->
            <div class="info-card">
                <h3 class="text-lg font-bold text-gray-800 mb-4">📤 输出</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700" id="stepOutput">
                    --
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="info-card">
            <h3 class="text-lg font-bold text-gray-800 mb-4">📄 相关文档 (<span id="docCount">0</span>)</h3>
            <div id="documentsContainer">
                <div class="text-center text-gray-500 py-8">暂无文档</div>
            </div>
        </div>

        <!-- Process Timeline -->
        <div class="info-card">
            <h3 class="text-lg font-bold text-gray-800 mb-4">🔄 流程时间线</h3>
            <div id="timelineContainer">
                <!-- Timeline will be generated here -->
            </div>
        </div>
    </main>

    <script>
        let currentProcessFlow = null;
        let currentStep = null;
        let stepId = null;
        let processId = null;

        // 页面加载时获取数据
        window.addEventListener('DOMContentLoaded', function() {
            // 确保数据已初始化
            if (typeof processFlowService !== 'undefined') {
                processFlowService.initializeMockData();
            }

            const urlParams = new URLSearchParams(window.location.search);
            processId = urlParams.get('processId');
            stepId = urlParams.get('stepId');

            if (!processId || !stepId) {
                console.error('缺少必要参数');
                alert('缺少必要参数！');
                window.location.href = 'project-management.html';
                return;
            }

            console.log('获取流程和环节:', processId, stepId);

            // 获取流程数据
            currentProcessFlow = processFlowService.getProcessFlow(processId);

            if (!currentProcessFlow) {
                alert('流程不存在！');
                window.location.href = 'project-management.html';
                return;
            }

            currentStep = currentProcessFlow.steps[stepId];

            if (!currentStep) {
                alert('环节不存在！');
                window.history.back();
                return;
            }

            // 渲染页面
            renderStepHeader();
            renderTimeInfo();
            renderInputOutput();
            renderDocuments();
            renderTimeline();
            updateBreadcrumb();
        });

        // 渲染环节头部
        function renderStepHeader() {
            const stepNames = {
                '1.1': '需求澄清',
                '1.2': '市场调研',
                '1.3': '需求设计',
                '1.4': '设计挑战',
                '1.5': '挑战回应',
                '1.6': '人类裁决',
                '1.7': '设计更新',
                '1.8': '人类评估',
                '1.9': '文档修改',
                '1.11': '差异检查',
                '1.12': '文档精炼',
                '1.13': '强制检查点'
            };

            document.getElementById('stepTitle').textContent = `${stepId} ${stepNames[stepId]}`;
            document.getElementById('stepName').textContent = `${stepId} ${stepNames[stepId]}`;

            // 状态
            const statusMap = {
                'pending': { text: '待开始', class: 'bg-yellow-100 text-yellow-700' },
                'in_progress': { text: '进行中', class: 'bg-blue-100 text-blue-700' },
                'completed': { text: '已完成', class: 'bg-green-100 text-green-700' },
                'skipped': { text: '已跳过', class: 'bg-gray-100 text-gray-700' }
            };
            const status = statusMap[currentStep.status] || statusMap['pending'];
            const statusElement = document.getElementById('stepStatus');
            statusElement.textContent = status.text;
            statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${status.class}`;

            // Agent
            document.getElementById('stepAgent').textContent = currentStep.agentName ? `Agent: ${currentStep.agentName}` : '人工操作';

            // 图标
            const icons = {
                '1.1': 'fa-comments',
                '1.2': 'fa-search',
                '1.3': 'fa-file-text',
                '1.4': 'fa-flag',
                '1.5': 'fa-reply',
                '1.6': 'fa-gavel',
                '1.7': 'fa-refresh',
                '1.8': 'fa-check-square',
                '1.9': 'fa-edit',
                '1.11': 'fa-exchange',
                '1.12': 'fa-magic',
                '1.13': 'fa-shield'
            };
            document.getElementById('stepIcon').className = `fa ${icons[stepId] || 'fa-circle'} text-white text-3xl`;
        }

        // 渲染时间信息
        function renderTimeInfo() {
            const formatTime = (isoString) => {
                if (!isoString) return '--';
                return new Date(isoString).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            document.getElementById('startTime').textContent = formatTime(currentStep.startedAt);
            document.getElementById('endTime').textContent = formatTime(currentStep.completedAt);

            // 计算耗时
            if (currentStep.startedAt) {
                const start = new Date(currentStep.startedAt);
                const end = currentStep.completedAt ? new Date(currentStep.completedAt) : new Date();
                const diffMs = end - start;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('duration').textContent = currentStep.completedAt
                    ? `${diffHours}小时${diffMins}分钟`
                    : `进行中（已耗时${diffHours}小时${diffMins}分钟）`;
            } else {
                document.getElementById('duration').textContent = '--';
            }
        }

        // 渲染输入输出
        function renderInputOutput() {
            document.getElementById('stepInput').textContent = currentStep.input || '无输入信息';
            document.getElementById('stepOutput').textContent = currentStep.output || '暂无输出（环节尚未完成）';
        }

        // 渲染文档
        function renderDocuments() {
            const container = document.getElementById('documentsContainer');
            const docs = currentStep.documents || [];

            document.getElementById('docCount').textContent = docs.length;

            if (docs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">暂无文档</div>';
                return;
            }

            container.innerHTML = docs.map(doc => `
                <div class="doc-card">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <i class="fa fa-file-text text-blue-500 text-xl"></i>
                                <h4 class="font-bold text-gray-800">${doc.type}</h4>
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${doc.version || 'v1.0'}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <i class="fa fa-clock-o mr-1"></i>
                                创建于 ${new Date(doc.createdAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <button class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-all" onclick="viewDocument('${doc.id}')">
                            <i class="fa fa-eye mr-1"></i>查看
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染时间线
        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            const stepOrder = ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7', '1.8', '1.9', '1.11', '1.12', '1.13'];

            const currentIndex = stepOrder.indexOf(stepId);
            const relatedSteps = stepOrder.slice(Math.max(0, currentIndex - 1), currentIndex + 3);

            container.innerHTML = relatedSteps.map((id, index) => {
                const step = currentProcessFlow.steps[id];
                if (!step) return '';

                const isCurrent = id === stepId;
                const statusColors = {
                    'completed': 'bg-green-500',
                    'in_progress': 'bg-blue-500',
                    'pending': 'bg-gray-300',
                    'skipped': 'bg-gray-400'
                };

                return `
                    <div class="flex items-start mb-4 ${isCurrent ? 'bg-blue-50 -mx-4 px-4 py-2 rounded-lg' : ''}">
                        <div class="flex flex-col items-center mr-4">
                            <div class="w-8 h-8 rounded-full ${statusColors[step.status]} flex items-center justify-center">
                                ${step.status === 'completed' ? '<i class="fa fa-check text-white"></i>' :
                                  step.status === 'in_progress' ? '<i class="fa fa-spinner fa-spin text-white"></i>' :
                                  '<div class="w-3 h-3 bg-white rounded-full"></div>'}
                            </div>
                            ${index < relatedSteps.length - 1 ? '<div class="w-0.5 h-12 bg-gray-300 mt-1"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 ${isCurrent ? 'text-blue-600' : ''}">${id} ${step.name}</h4>
                            <p class="text-sm text-gray-600">
                                ${step.completedAt ? `完成于 ${new Date(step.completedAt).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}` :
                                  step.startedAt ? `开始于 ${new Date(step.startedAt).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}` :
                                  '待开始'}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 更新面包屑
        function updateBreadcrumb() {
            if (currentProcessFlow.projectId) {
                document.getElementById('projectLink').href = `project-detail.html?id=${currentProcessFlow.projectId}`;
            }
            if (currentProcessFlow.versionId) {
                document.getElementById('versionLink').href = `version-detail.html?projectId=${currentProcessFlow.projectId}&versionId=${currentProcessFlow.versionId}`;
            }
            document.getElementById('processLink').href = `process-flow-detail.html?processId=${processId}`;
            document.getElementById('processLink').textContent = currentProcessFlow.name;
        }

        // 返回流程页
        function goBack() {
            window.location.href = `process-flow-detail.html?processId=${processId}`;
        }

        // 查看文档
        function viewDocument(docId) {
            alert(`查看文档功能开发中\n文档ID: ${docId}`);
        }
    </script>
</body>
</html>
